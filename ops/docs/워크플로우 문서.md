# 🐳자동 빌드+배포 가이드: 
# 백엔드 RunPod 배포 + 프론트엔드 컨테이너 빌드/배포

---
# 자동 빌드 & 배포 시스템 가이드 (Netlify + RunPod 기준)

## 1. 시스템 개요
GitHub Actions를 활용한 자동화 배포 시스템으로 다음 기능을 제공합니다:
- 백엔드/프론트엔드 도커 이미지 자동 빌드
- GitHub Container Registry(GHCR)에 이미지 푸시
- RunPod에 백엔드 컨테이너 자동 배포
- 프론트엔드는 Netlify에 별도 배포 (기본 설정)

## 2. 워크플로우 설정

### 2.1 워크플로우 파일 위치
`.github/workflows/deploy.yml`


### 2.2 실행 조건
- `v`로 시작하는 태그가 메인 브랜치에 푸시될 때만 실행
- 예: `git tag v1.0 && git push origin v1.0`

## 3. 필수 설정

### 3.1 RunPod 설정
1. [RunPod 콘솔](https://www.runpod.io/console/pods)에서 팟 생성
2. 필수 설정 값:
   - GPU: 1개 (NVIDIA RTX 5000 등)
   - Container Disk: 20GB
   - Port: `8000/http`
   - 환경변수: `NVIDIA_VISIBLE_DEVICES=all`

### 3.2 GitHub Secrets
리포지토리 Settings → Secrets and variables → Actions에서 다음 값 설정:

| Secret 이름             | 설명                     |
|------------------------|--------------------------|
| RUNPOD_API_KEY         | RunPod API 키            |
| RUNPOD_BACKEND_POD_ID  | 생성한 백엔드 팟 ID      |
| SERVICE_KEY            | 백엔드 서비스 키         |
| NAVER_CLIENT_ID        | 네이버 API 클라이언트 ID |
| NAVER_CLIENT_SECRET    | 네이버 API 클라이언트 시크릿 |

### 3.3 RunPod과 프라이빗 리포지토리 연동

1. **GitHub Personal Access Token 생성**  
   - GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic) → Generate new token (classic)  
   - 권한 설정:  
     - `read:packages` ✅  
     - `repo` (프라이빗 저장소인 경우) ✅  
   - 생성된 토큰 복사 (한 번만 표시됨)

2. **RunPod에 컨테이너 레지스트리 인증 추가**  
   - RunPod 대시보드 → Settings → Container Registry → Add Registry  
   - 입력 정보:  
     - **Registry URL**: `ghcr.io`  
     - **Username**: GitHub 사용자명  
     - **Password**: 생성한 Personal Access Token  
   - 저장 후 생성된 **Auth ID** 복사 (예: `clzdaifot0001l90809257ynb`)

3. **GitHub Actions 업데이트**  

```yaml
   - name: Update backend container on RunPod
  run: |
    # ... (기존 코드 유지) ...
    
    # 팟 업데이트 부분 수정
    UPDATE_RESPONSE=$(curl -s --request PATCH \
      --url "$RUNPOD_API_BASE/$POD_ID" \
      --header "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
      --header "Content-Type: application/json" \
      --data "{
        \"imageName\": \"$IMAGE_NAME_LOWER\",
        \"containerDiskInGb\": 20,
        \"containerRegistryAuthId\": \"${{ secrets.RUNPOD_REGISTRY_AUTH_ID }}\",
        \"ports\": [\"8000/http\"],
        \"env\": {
          \"NVIDIA_VISIBLE_DEVICES\": \"all\",
          \"SERVICE_KEY\": \"${{ secrets.SERVICE_KEY }}\",
          \"NAVER_CLIENT_ID\": \"${{ secrets.NAVER_CLIENT_ID }}\",
          \"NAVER_CLIENT_SECRET\": \"${{ secrets.NAVER_CLIENT_SECRET }}\"
        },
        \"volumeInGb\": 50,
        \"volumeMountPath\": \"/workspace\"
      }")

   # ... (나머지 코드 유지) ...
```

4. **GitHub Secrets 추가**
- Settings → Secrets and variables → Actions → New repository secret
- Name: RUNPOD_REGISTRY_AUTH_ID
- Value: RunPod에서 복사한 Auth ID


## 4. 배포 프로세스

1. 이미지 빌드 단계:
   - 백엔드/프론트엔드 도커 이미지 빌드
   - GHCR에 이미지 푸시

2. 배포 단계:
   - 기존 RunPod 팟 중지
   - 새 이미지로 팟 업데이트
   - 팟 재시작

## 5. 이미지 사용 방법


# 백엔드 이미지 가져오기
> docker pull ghcr.io/chatbot-with-kt-dgucenter/chatbot-with-kt-dgucenter-backend:latest

# 프론트엔드 이미지 가져오기
> docker pull ghcr.io/chatbot-with-kt-dgucenter/chatbot-with-kt-dgucenter-frontend:latest


## 6. 환경변수 관리

- **GitHub Secrets**: CI/CD 자동화용 민감정보 저장
- **RunPod 환경변수**: 백엔드 실행시 필요한 설정값
- **Netlify 환경변수**: 프론트엔드 빌드시 필요한 값

> 주의: 모든 민감정보는 반드시 Secrets이나 환경변수로 관리해야 합니다.

## 7. 문제 해결

- **팟 업데이트 실패**: RunPod 콘솔에서 수동 확인
- **이미지 푸시 실패**: GitHub Token 권한 확인
- **환경변수 오류**: Secrets 값 재확인

## 8. Netlify 이용 배포
 - Netlify : 도커 사용 X
 - 연결된 리포지토리에 Push가 있을때마다 자동으로 소스코드를 업데이트합니다.
- **Frontend/src/conponents/ChatBot.jsx 파일 업데이트 필요**
```
      // ===================================================================
      // [Netlify Functions 사용 시] - 아래 1줄 주석 해제하고 나머지 주석 처리
      // const endpoint = '/.netlify/functions/chat';
      // ===================================================================
      // [백엔드 직접 호출 시] - 아래 2줄 주석 해제 (도커, 소스코드 배포 기본값)
      //const API_URL = process.env.REACT_APP_API_URL;
      //const endpoint = `${API_URL}/api/chat`;
      // ===================================================================
```
- 현재는 도커 이미지 배포가 주 목적이기 때문에, Netlify에서도 직접호출 코드를 사용합니다.
- 하지만 이방식은 요청 URL에 백엔드 서버의 키가 직접적으로 포함되므로 보안상으로 안전하지 않습니다
- Netlify의 런타임 전달 기능을 활성화 하는 함수를 구현해두어서, 해당 소스파일만 수정시 바로 적용 가능합니다.
> 넷플리파이 설정파일 **Netlify/~ , netlify.toml** 
- Netlify 웹상에서 Secret등록 및 function기능 활성화 필요.